<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auctions App</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js" defer></script>
    <script src="main.js" defer></script>
</head>
<body>
<div id="app">
    <h1>Auctions App</h1>

   <!-- <div id="main-buttons">
        <div v-if="!authenticated && !showLoginForm">
            <button @click="toggleLoginForm">Sign in / Sign up</button>
        </div>

        

    </div> -->

    <!-- Bottone Login/Signup -->
    <div v-if="!authenticated && !showLoginForm">
        <button @click="toggleLoginForm">Sign in / Sign up</button>
    </div> 

    <!-- Sezione Login/Signup -->
    <div v-if="showLoginForm">
        <h2>Sign in</h2>
        <form @submit.prevent="signin">
            <label>Username: <input type="text" v-model="signinData.username" required/></label>
            <label>Password: <input type="password" v-model="signinData.password" required/></label>
            <button type="submit">Sign in</button>
        </form>

        <h2>Sign up</h2>
        <form @submit.prevent="signup">
            <label>Username: <input type="text" v-model="signupData.username" required/></label>
            <label>Name: <input type="text" v-model="signupData.name" required/></label>
            <label>Surname: <input type="text" v-model="signupData.surname" required/></label>
            <label>Password: <input type="password" v-model="signupData.password" required/></label>
            <button type="submit">Sign up</button>
        </form>
        <button @click="toggleLoginForm">Back</button>
    </div>

    <!-- Dashboard Utente -->
    <div v-if="authenticated">
        <h2>Welcome, {{ userInfo.username }}</h2>
        <!--        <button class="logout-button" @click="signout">Sign out</button>-->
        <button @click="toggleNewAuctionForm">New Auction</button>
        <button @click="togglePersonalArea">Personal Area</button>


        <!-- Creazione Nuova Asta -->
        <div v-if="showNewAuctionForm">
            <h2>Create a New Auction</h2>
            <form @submit.prevent="createAuction">
                <label>Title: <input type="text" v-model="newAuction.title" required/></label>
                <label>Description: <input type="text" v-model="newAuction.description" required></label>
                <label>Starting price: <input type="number" v-model="newAuction.startPrice" required></label>
                <label>End Time: <input type="datetime-local" v-model="newAuction.endTime" required></label>
                <button type="submit">Create</button>
            </form>
        </div>

        <div v-if="showPersonalArea">
            <h2>Personal Area</h2>
            Name: {{ userInfo.name }} <br>
            Surname: {{ userInfo.surname }} <br>
            <button @click="fetchUserCreatedAuctions">Your Auctions</button><br>
            <ul>
                <li v-for="auction in userCreatedAuctions" :key="auction.id">
                {{ auction.title }}<br>
                {{ auction.description }}<br>
                    <button @click="deleteAuction(auction.id)">Delete</button>
                    <button @click="toggleEditAuctionForm(auction.id)">Edit</button>
                    <div v-if="showEditAuctionForm">
                        Edit Auction:
                        <form @submit.prevent="editAuction(auction.id)">
                            <label>Title: <input type="text" v-model="editedAuction.title" required/></label>
                            <label>Description: <input type="text" v-model="editedAuction.description" required></label>
                            <button type="submit">Edit</button>
                        </form>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Elenco Aste -->
    <div v-if="!showLoginForm && !showPersonalArea">
        <h2>Auctions</h2>
        <form @submit.prevent="fetchAuctions">

            <label>
                <input type="text" v-model="auctionsQuery" placeholder="Search in auctions..."/>
            </label>

            <button type="submit">Search auctions</button>
        </form>
        <ul>
            <li v-for="auction in auctions" :key="auction.id">
                <strong>{{ auction.title }}</strong><br>
                {{ auction.description }} <br>
                Current Price: {{ auction.currentPrice }} € <br>
                Auction ends on: {{ formatDate(auction.endTime) }} <br>
                Status: {{ printStatus(auction.open) }} <br>
                Won by {{ auction.winner }} <br>

                <button @click="toggleBidsHistory(auction.id)">History</button>

                <div v-if="showBidsHistory && selectedAuction === auction.id">
                    <ul>
                        <li v-for="bid in auction.bidsHistory" :key="bid.id">
                            Bidder: {{ bid.bidder }} <br>
                            Amount: {{ bid.amount }}€<br>
                            Made on: {{ formatDate(bid.timestamp) }} <br>
                        </li>
                    </ul>
                </div>

                <button v-if="isAuctionOpen(auction.endTime) && authenticated" @click="toggleNewBidForm(auction.id)">Bid</button>

                <div v-if="showNewBidForm && selectedAuction === auction.id && isAuctionOpen(auction.endTime) && authenticated">
                    <form @submit.prevent="makeNewBid">
                        The bid amount has to be higher than {{ auction.currentPrice}} €<br>
                        <label>Your bid: <input type="number" step="0.01" min="0" v-model="newBid.amount"></label>
                        <button type="submit">Make bid</button>
                    </form>
                </div>
            </li>
        </ul>
    </div>

    <div v-if="!showLoginForm && !showPersonalArea">
        <h2>Users</h2>
        <form @submit.prevent="fetchUsers">
            <label>
                <input type="text" v-model="usersQuery" placeholder="Search users..."/>
            </label>
            <button type="submit">Search users</button>
        </form>
        <ul>
            <li v-for="user in users" :key="user.id">
                <strong>{{ user.username }}</strong><br>

                <button @click="toggleMoreUserInfo(user.id)">About</button>

                <div v-if="user.id === selectedUserId">
                    Name: {{ user.name }} <br>
                    Surname: {{ user.surname }} <br>
                    Auctions already won: <br>
                    <ul>
                        <li v-for="bid in user.winningBids">
                            <strong>{{ bid.item }}</strong><br>
                            For {{ bid.amount }} €<br>
                            On: {{ formatDate(bid.timestamp) }}<br>
                        </li>
                    </ul>
                </div>

            </li>
        </ul>
    </div>


</div>
</body>
</html>
